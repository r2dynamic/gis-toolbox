<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GIS Toolbox</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1c1c1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="anonymous">

    <!-- App CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/mobile.css">

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23e8b84a'/><stop offset='1' stop-color='%23d4a24e'/></linearGradient></defs><circle cx='32' cy='32' r='28' fill='none' stroke='url(%23g)' stroke-width='3'/><ellipse cx='32' cy='32' rx='14' ry='28' fill='none' stroke='url(%23g)' stroke-width='2'/><line x1='4' y1='32' x2='60' y2='32' stroke='url(%23g)' stroke-width='2'/><path d='M8 20h48M8 44h48' stroke='url(%23g)' stroke-width='1.5' opacity='.6'/><circle cx='44' cy='16' r='8' fill='%23d4a24e'/><path d='M44 10a6 6 0 0 1 6 6c0 4-6 10-6 10s-6-6-6-10a6 6 0 0 1 6-6z' fill='%23e8b84a'/><circle cx='44' cy='16' r='2.5' fill='%230f1117'/></svg>">
</head>
<body>
    <!-- ================================ -->
    <!-- HEADER                           -->
    <!-- ================================ -->
    <header class="header">
        <div class="header-left">
            <span class="header-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="28" height="28"><defs><linearGradient id="hg" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#e8b84a"/><stop offset="1" stop-color="#d4a24e"/></linearGradient></defs><circle cx="32" cy="32" r="28" fill="none" stroke="url(#hg)" stroke-width="3"/><ellipse cx="32" cy="32" rx="14" ry="28" fill="none" stroke="url(#hg)" stroke-width="2"/><line x1="4" y1="32" x2="60" y2="32" stroke="url(#hg)" stroke-width="2"/><path d="M8 20h48M8 44h48" stroke="url(#hg)" stroke-width="1.5" opacity=".6"/><circle cx="44" cy="16" r="8" fill="#d4a24e"/><path d="M44 10a6 6 0 0 1 6 6c0 4-6 10-6 10s-6-6-6-10a6 6 0 0 1 6-6z" fill="#e8b84a"/><circle cx="44" cy="16" r="2.5" fill="#0f1117"/></svg></span>
            <h1 class="header-title">GIS Toolbox</h1>
        </div>
        <div class="header-center">
            <button class="btn btn-primary btn-sm" id="btn-import">
                <span class="btn-icon-text">üìÇ</span><span>Import</span>
            </button>
            <button class="btn btn-secondary btn-sm" id="btn-photo-mapper">
                <span class="btn-icon-text">üì∑</span><span>Photos</span>
            </button>
            <button class="btn btn-secondary btn-sm" id="btn-arcgis">
                <span class="btn-icon-text">üåê</span><span>ArcGIS</span>
            </button>
            <button class="btn btn-secondary btn-sm" id="btn-coordinates">
                <span class="btn-icon-text">üìç</span><span>Coords</span>
            </button>
            <button class="btn btn-secondary btn-sm" id="btn-draw-layer">
                <span class="btn-icon-text">‚úèÔ∏è</span><span>Draw</span>
            </button>
            <div class="header-sep"></div>
            <button class="btn btn-ghost btn-sm" id="btn-undo" disabled title="Undo">‚Ü©</button>
            <button class="btn btn-ghost btn-sm" id="btn-redo" disabled title="Redo">‚Ü™</button>
            <button class="btn btn-secondary btn-sm hidden" id="btn-merge">Merge Layers</button>
        </div>
        <div class="header-right">
            <!-- Mobile overflow menu button (hidden on desktop) -->
            <button class="btn btn-ghost btn-sm mobile-menu-btn" id="btn-mobile-menu" title="Menu">‚ò∞</button>
            <select id="basemap-select" class="btn-sm" title="Basemap">
                <option value="osm">Street Map</option>
                <option value="light">Light / Gray</option>
                <option value="dark">Dark</option>
                <option value="voyager" selected>Voyager</option>
                <option value="topo">Topographic</option>
                <option value="satellite">Satellite</option>
                <option value="hybrid">Hybrid</option>
                <option value="none">No Basemap</option>
            </select>
            <button class="btn btn-ghost btn-sm" id="btn-logs" title="Logs">üìã</button>
            <button class="btn btn-ghost" id="btn-info" title="Tool Guide" style="font-size:22px;padding:2px 6px;line-height:1;">‚ÑπÔ∏è</button>
        </div>
    </header>

    <!-- Mobile dropdown menu (hidden on desktop) -->
    <div class="mobile-dropdown-menu hidden" id="mobile-dropdown-menu">
        <button class="mobile-menu-item" data-action="import"><span>üìÇ</span><span>Import Data</span></button>
        <button class="mobile-menu-item" data-action="photos"><span>üì∑</span><span>Photo Mapper</span></button>
        <button class="mobile-menu-item" data-action="arcgis"><span>üåê</span><span>ArcGIS REST</span></button>
        <button class="mobile-menu-item" data-action="coords"><span>üìç</span><span>Coordinates</span></button>
        <button class="mobile-menu-item" data-action="draw"><span>‚úèÔ∏è</span><span>Draw</span></button>
        <div class="mobile-menu-sep"></div>
        <button class="mobile-menu-item" data-action="logs"><span>üìã</span><span>Logs</span></button>
        <button class="mobile-menu-item" data-action="info"><span>‚ÑπÔ∏è</span><span>Tool Guide</span></button>
    </div>

    <!-- ================================ -->
    <!-- MAIN 3-PANEL LAYOUT (Desktop)    -->
    <!-- ================================ -->
    <div class="app-layout">

        <!-- LEFT PANEL -->
        <aside class="panel panel-left">
            <div class="panel-header">
                <span>Layers & Fields</span>
                <button class="btn-icon" id="toggle-left-panel" title="Collapse">‚óÄ</button>
            </div>
            <div class="panel-body">
                <!-- Layer List -->
                <div class="panel-section">
                    <div class="panel-section-header" onclick="toggleSection(this)">
                        Layers <span class="arrow">‚ñº</span>
                    </div>
                    <div class="panel-section-body" id="layer-list">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;margin:0 auto 12px;">
                                <path d="M12 16v-4m0-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>No layers loaded.<br>Import a file or use a tool to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Field List -->
                <div class="panel-section">
                    <div class="panel-section-header" onclick="toggleSection(this)">
                        Fields <span class="arrow">‚ñº</span>
                    </div>
                    <div class="panel-section-body" id="field-list">
                        <div class="text-muted text-sm p-8">Select a layer to view fields</div>
                    </div>
                </div>

                <!-- Layer Data Tools -->
                <div id="dataprep-tools"></div>
            </div>
        </aside>

        <!-- CENTER PANEL ‚Äî MAP -->
        <main class="panel-center">
            <div id="map-container">
                <div class="map-overlay" id="map-drop-overlay">
                    <div>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;">
                            <path d="M12 16v-4m0-4h.01M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7l3-7z"/>
                        </svg>
                        <p style="margin-top:12px; font-size:18px; font-weight:600;">Drop files here to import</p>
                        <p class="text-sm text-muted">GeoJSON, CSV, Excel, KML, KMZ, Shapefile (ZIP)</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT PANEL -->
        <aside class="panel panel-right">
            <div class="panel-header">
                <button class="btn-icon" id="toggle-right-panel" title="Collapse">‚ñ∂</button>
                <span>Output & Export</span>
            </div>
            <div class="panel-body" id="output-panel-content">
                <div class="empty-state">
                    <p>No layer selected</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Expand tabs for collapsed panels (outside app-layout so they aren't clipped) -->
    <button class="panel-expand-tab panel-expand-left hidden" id="expand-left-panel" title="Expand Layers">‚ñ∂</button>
    <button class="panel-expand-tab panel-expand-right hidden" id="expand-right-panel" title="Expand Export">‚óÄ</button>

    <!-- ================================ -->
    <!-- LOGS PANEL (slides up)           -->
    <!-- ================================ -->
    <div id="logs-panel" class="logs-panel hidden">
        <div class="logs-header">
            <h3>Logs</h3>
            <div class="logs-toolbar">
                <input type="search" id="logs-search" placeholder="Search logs..." class="input-sm">
                <select id="logs-level" class="input-sm">
                    <option value="">All Levels</option>
                    <option value="ERROR">Errors</option>
                    <option value="WARN">Warnings</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
                <button class="btn btn-ghost btn-sm" id="logs-copy" title="Copy logs">üìã</button>
                <button class="btn btn-ghost btn-sm" id="logs-download" title="Download logs">üíæ</button>
                <button class="btn btn-ghost btn-sm" id="logs-clear" title="Clear">üóëÔ∏è</button>
                <button class="btn btn-ghost btn-sm" onclick="document.getElementById('logs-panel').classList.add('hidden')">‚úï</button>
            </div>
        </div>
        <div class="logs-body" id="logs-body"></div>
    </div>

    <!-- ================================ -->
    <!-- MOBILE BOTTOM NAV                -->
    <!-- ================================ -->
    <nav class="mobile-nav">
        <div class="mobile-nav-item active" data-tab="map">
            <span>üó∫Ô∏è</span>
            <span>Map</span>
        </div>
        <div class="mobile-nav-item" data-tab="data">
            <span>üìä</span>
            <span>Layers</span>
        </div>
        <div class="mobile-nav-item" data-tab="prep">
            <span>üîß</span>
            <span>Data</span>
        </div>
        <div class="mobile-nav-item" data-tab="tools">
            <span>‚öôÔ∏è</span>
            <span>GIS Tools</span>
        </div>
        <div class="mobile-nav-item" data-tab="export">
            <span>üíæ</span>
            <span>Export</span>
        </div>
    </nav>

    <!-- Mobile content panels (hidden on desktop) -->
    <div class="mobile-content hidden" id="mobile-data"></div>
    <div class="mobile-content hidden" id="mobile-prep"></div>
    <div class="mobile-content hidden" id="mobile-tools"></div>
    <div class="mobile-content hidden" id="mobile-export"></div>

    <!-- ================================ -->
    <!-- LIBRARY SCRIPTS (CDN, NO API KEYS) -->
    <!-- ================================ -->
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="anonymous"></script>

    <!-- PapaParse (CSV) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- SheetJS / XLSX (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

    <!-- JSZip (KMZ, Shapefile ZIP) -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

    <!-- toGeoJSON (KML) -->
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.2/togeojson.js"></script>

    <!-- Turf.js (GIS analysis) -->
    <script src="https://unpkg.com/@turf/turf@7.1.0/turf.min.js"></script>

    <!-- shpjs (Shapefile) -->
    <script src="https://unpkg.com/shpjs@4.0.4/dist/shp.js"></script>

    <!-- exifr (Photo EXIF) -->
    <script src="https://unpkg.com/exifr@7.1.3/dist/full.umd.js"></script>

    <!-- App Entry Point -->
    <script type="module" src="js/app.js"></script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const worker = reg.installing;
                    worker.onstatechange = () => {
                        if (worker.state === 'activated') {
                            window.location.reload();
                        }
                    };
                };
            });
        }
    </script>
</body>
</html>
